#include <tunables/global>

profile hass_foundryvtt flags=(attach_disconnected,mediate_deleted) {
  # Base HA add-on allowances (keep)
  #include <abstractions/base>

  # Capabilities used by init/services
  file,
  signal (send) set=(kill,term,int,hup,cont),

  # ---- S6-Overlay scaffolding (from HA example; keep) ----
  /init ix,
  /bin/** ix,
  /usr/bin/** ix,
  /run/{s6,s6-rc*,service}/** ix,
  /package/** ix,
  /command/** ix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /run/{,**} rwk,
  /dev/tty rw,

  # ---- Bashio & temp ----
  /usr/lib/bashio/** ix,
  /tmp/** rwk,

  # ---- Add-on persistent storage ----
  /data/** rw,

  # ---- Launch Foundry under Node subprofile ----
  /usr/bin/node cx -> foundry_node,

  # ---------------------------------------------------------
  # Subprofile: Node/Foundry service (start in complain while learning)
  profile foundry_node flags=(attach_disconnected,mediate_deleted) {
	# Baseline
	#include <abstractions/base>
	#include <abstractions/nameservice>
	#include <abstractions/ssl_certs>
	network,

	# --- Broad READ of system trees ---
	/etc/** r,
	/usr/share/** r,
	/usr/include/** r,        # harmless includes if present
	/lib/** mr,               # shared libs: read + mmap
	/usr/lib/** mr,           # shared libs: read + mmap
	/proc/** r,
	/sys/** r,

	# Optional: timezones/localtime may live in /etc or /usr/share
	/etc/localtime r,

	# --- Writable areas only where needed ---
	/share/foundryvtt_data/** rwcdt,
	/tmp/** rwcdt,
	/root/.local/** rwc,
	/root/.cache/** rwc,
	/root/.npm/** rwc,

	# --- Guard rails (deny a few obvious secrets if present) ---
	deny /etc/shadow r,
	deny /etc/ssh/** r,
	deny /etc/ssl/private/** r,

	# Receive signals from S6-Overlay
	signal (receive) peer=*_hass_foundryvtt,

	# --- Hardening: deny dangerous caps ---
	deny capability sys_admin,
	deny capability sys_module,
	deny capability sys_ptrace,

	# --- Node runtime & OS config reads ---
	/usr/bin/node mr,
	/run/systemd/resolve/{resolv.conf,stub-resolv.conf} r,

	# --- Foundry+mods data: confine writes to add-on dirs ---
	/data/** rwk, # Install location
	/tmp/** rwk,  # Temp/cache

	# Narrow /share to a specific subtree (avoid broad /share/** if not needed)
	/share/foundry_data/** rwk,

	# Broad READ of tool directories
	/bin/** r,
	/usr/bin/** r,
	/sbin/** r,
	/usr/sbin/** r,

	# If the app needs to EXEC tools, enable inherit-exec (still confined).
	# Comment these out if you donâ€™t want any external tool execution.
	/bin/** ix,
	/usr/bin/** ix,
	/sbin/** ix,
	/usr/sbin/** ix,

	# --- Keep from template as needed ---
	/bin/echo ix,
	/etc/passwd r,
	/dev/tty rw,
  }
}
