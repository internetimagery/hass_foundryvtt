#include <tunables/global>

profile hass_foundryvtt flags=(attach_disconnected,mediate_deleted) {
  # Base HA add-on allowances (keep)
  #include <abstractions/base>

  # Capabilities used by init/services
  file,
  signal (send) set=(kill,term,int,hup,cont),

  # ---- S6-Overlay scaffolding (from HA example; keep) ----
  /init ix,
  /bin/** ix,
  /usr/bin/** ix,
  /run/{s6,s6-rc*,service}/** ix,
  /package/** ix,
  /command/** ix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /run/{,**} rwk,
  /dev/tty rw,

  # ---- Bashio & temp ----
  /usr/lib/bashio/** ix,
  /tmp/** rwk,

  # ---- Add-on persistent storage ----
  /data/** rw,

  # ---- Launch Foundry under Node subprofile ----
  /usr/bin/node cx -> foundry_node,

  # ---------------------------------------------------------
  # Subprofile: Node/Foundry service (start in complain while learning)
  profile foundry_node flags=(attach_disconnected,mediate_deleted,complain) {
    # Common safe defaults + DNS
    #include <abstractions/base>
    #include <abstractions/nameservice>                 # DNS resolver access

    # --- Networking (HTTP/WebSocket + outbound) ---
    network,

    # If you bind privileged ports (<1024), keep this; otherwise you can remove it:
    capability net_bind_service,                        # Capabilities are mediated by AppArmor

    # --- Hardening: deny dangerous caps ---
    deny capability sys_admin,
    deny capability sys_module,
    deny capability sys_ptrace,

    # --- Node runtime & OS config reads ---
    /etc/ssl/**                      r,
    /usr/bin/node                    mr,
    /usr/lib/**                      r,
    /lib/**                          r,
    /etc/ld.so.cache                 r,
    /etc/{hosts,host.conf,nsswitch.conf,resolv.conf,passwd,gai.conf} r,
    /run/systemd/resolve/{resolv.conf,stub-resolv.conf} r,

    # Debian/Ubuntu packaged node modules (keep if your base image uses them)
    /usr/share/nodejs/**             r,
    /usr/share/ca-certificates/**    r,

    # --- Foundry+mods data: confine writes to add-on dirs ---
    /data/**                         rwk,               # worlds/modules/assets/logs per HA add-on layout
    /tmp/**                          rwk,               # temp/cache

    # Narrow /share to a specific subtree (avoid broad /share/** if not needed)
    /share/foundry_data/**           rwk,

    # --- Minimal procfs reads ---
    /proc/**                         r,

    # --- Optional helper tools mods may spawn (trim to what you need) ---
    /usr/bin/{bash,sh,dash}          rix,
    /usr/bin/{ffmpeg,convert,identify} ix,
    /usr/bin/{tar,zip,unzip}         ix,
    # Add more here only if required by your mods (e.g., curl, sox, pdftoppm)

    # --- Keep from template as needed ---
    /bin/echo ix,
    /etc/passwd r,
    /dev/tty rw,
  }
}
